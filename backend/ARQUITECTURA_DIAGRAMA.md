# ğŸ—ï¸ DIAGRAMA DE ARQUITECTURA - Sistema de IntegraciÃ³n WhatsApp

## Flujo General del Sistema

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                        MUHUTRAVEL CRM SYSTEM                        â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CAPA FRONTEND                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   React Components       â”‚  â”‚   WhatsAppService.js           â”‚  â”‚
â”‚  â”‚  (Comunicacion.js,       â”‚  â”‚  (Socket.IO Client)            â”‚  â”‚
â”‚  â”‚   Dashboard, etc)        â”‚  â”‚  - emit(send_message)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - on(new_message_received)    â”‚  â”‚
â”‚               â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                              â”‚                       â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                  â”‚                                   â”‚
â”‚                          â—† Socket.IO â—†                             â”‚
â”‚                                  â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    HTTP Request  â”‚  HTTP Response
                    Socket.IO      â”‚  Socket.IO
                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CAPA SERVIDOR                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      app.js                                  â”‚   â”‚
â”‚  â”‚  (Servidor Express Principal + Socket.IO)                    â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”œâ”€ app.locals.io â—„â”€â”€â”€â”€â”€â–º Socket.IO Instance              â”‚   â”‚
â”‚  â”‚  â”œâ”€ app.locals.whatsappIntegration â—„â”€ WhatsAppIntegration  â”‚   â”‚
â”‚  â”‚  â””â”€ app.use('/api/comunicacion', comunicacionRouter)        â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€ WhatsAppBot (Baileys)                                   â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ connect()                                            â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ handleIncomingMessage()                              â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ sendMessage()                                        â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ setupSocketHandlers()                                â”‚   â”‚
â”‚  â”‚  â””â”€                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â–²      â–¼                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                   â”‚      â”‚                   â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ comunicacion   â”‚  â”‚ whatsappIntegration â”‚  â”‚ Otros routes â”‚       â”‚
â”‚  â”‚     .js        â”‚  â”‚        .js          â”‚  â”‚  (usuarios,  â”‚       â”‚
â”‚  â”‚                â”‚  â”‚  (Servicio Central) â”‚  â”‚  clientes,   â”‚       â”‚
â”‚  â”‚ Rutas REST:    â”‚  â”‚                     â”‚  â”‚  reportes)   â”‚       â”‚
â”‚  â”‚ â”œâ”€ GET /      â”‚  â”‚ MÃ©todos:            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”‚ â”‚ mensajes/   â”‚  â”‚ â”œâ”€ initialize()     â”‚                         â”‚
â”‚  â”‚ â”‚ :clienteId  â”‚  â”‚ â”œâ”€ enviarMensaje()  â”‚                         â”‚
â”‚  â”‚ â”‚             â”‚  â”‚ â”œâ”€ procesarMsg...()â”‚                         â”‚
â”‚  â”‚ â”œâ”€ POST /     â”‚  â”‚ â”œâ”€ obtenerHisto...()â”‚                        â”‚
â”‚  â”‚ â”‚ enviar      â”‚  â”‚ â””â”€ enviarMsg...o() â”‚                         â”‚
â”‚  â”‚ â”‚             â”‚  â”‚                     â”‚                         â”‚
â”‚  â”‚ â”œâ”€ POST /     â”‚  â”‚ IntegraciÃ³n BD:     â”‚                         â”‚
â”‚  â”‚ â”‚ webhook     â”‚  â”‚ â”œâ”€ Guarda mensajes  â”‚                         â”‚
â”‚  â”‚ â”‚             â”‚  â”‚ â”œâ”€ Obtiene historialâ”‚                        â”‚
â”‚  â”‚ â”‚             â”‚  â”‚ â””â”€ Verifica duplicadâ”‚                        â”‚
â”‚  â”‚ â””â”€ POST /     â”‚  â”‚                     â”‚                         â”‚
â”‚  â”‚   webhook/    â”‚  â”‚ IntegraciÃ³n Whapi:  â”‚                         â”‚
â”‚  â”‚   test        â”‚  â”‚ â”œâ”€ EnvÃ­a mensajes   â”‚                         â”‚
â”‚  â”‚               â”‚  â”‚ â”œâ”€ Recibe webhooks  â”‚                         â”‚
â”‚  â”‚ AutorizaciÃ³n: â”‚  â”‚ â””â”€ Simula sin Whapi â”‚                         â”‚
â”‚  â”‚ â”œâ”€ verificar  â”‚  â”‚                     â”‚                         â”‚
â”‚  â”‚ â”‚ Token       â”‚  â”‚ Eventos Socket.IO:  â”‚                         â”‚
â”‚  â”‚ â”‚             â”‚  â”‚ â”œâ”€ message_sent     â”‚                         â”‚
â”‚  â”‚ â”‚             â”‚  â”‚ â”œâ”€ new_message_rec..â”‚                        â”‚
â”‚  â”‚ â”‚             â”‚  â”‚ â”œâ”€ bulk_msg_...     â”‚                        â”‚
â”‚  â”‚ â”‚             â”‚  â”‚ â””â”€ whatsapp_status  â”‚                         â”‚
â”‚  â”‚ â””â”€            â”‚  â”‚                     â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                             â–¼                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚         â”‚         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ PostgreSQL  â”‚  â”‚ Whapi  â”‚  â”‚ Socket.IO    â”‚
        â”‚ Database    â”‚  â”‚  API   â”‚  â”‚   Events    â”‚
        â”‚             â”‚  â”‚        â”‚  â”‚             â”‚
        â”‚ - Clientes  â”‚  â”‚Endpointâ”‚  â”‚ Real-time   â”‚
        â”‚ - Mensajes  â”‚  â”‚:       â”‚  â”‚ Messaging   â”‚
        â”‚ - Reservas  â”‚  â”‚POST /  â”‚  â”‚             â”‚
        â”‚ - etc.      â”‚  â”‚msg     â”‚  â”‚ Conecta:    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚  â”‚ Frontend-   â”‚
                         â”‚GET /me â”‚  â”‚ Servidor    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Flujo de EnvÃ­o de Mensaje

```
â”Œâ”€ INICIO: Usuario escribe mensaje en Frontend
â”‚
â”œâ”€ emit('send_message', { to, message })
â”‚
â”œâ”€ Socket.IO Server recibe en app.js
â”‚
â”œâ”€ Route Handler: POST /api/comunicacion/enviar
â”‚
â”œâ”€ Obtiene: req.app.locals.whatsappIntegration
â”‚
â”œâ”€ Ejecuta: whatsappIntegration.enviarMensaje()
â”‚
â”œâ”€ Dentro del mÃ©todo:
â”‚  â”œâ”€ Valida datos (telefono, mensaje)
â”‚  â”‚
â”‚  â”œâ”€ Â¿WHAPI_TOKEN configurado?
â”‚  â”‚  â”œâ”€ SÃ â†’ enviarPorWhapi()
â”‚  â”‚  â”‚  â”œâ”€ POST https://api.whapi.cloud/messages/text
â”‚  â”‚  â”‚  â”œâ”€ Recibe: messageId
â”‚  â”‚  â”‚  â””â”€ Provider: 'whapi'
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ NO â†’ simularEnvio()
â”‚  â”‚     â”œâ”€ Genera messageId local
â”‚  â”‚     â””â”€ Provider: 'simulated'
â”‚  â”‚
â”‚  â”œâ”€ guardarMensajeEnBD(clienteId, mensaje, remitente, messageId)
â”‚  â”‚  â””â”€ INSERT INTO comunicacion_mensajes
â”‚  â”‚
â”‚  â””â”€ io.emit('message_sent', { messageId, telefono, mensaje, ... })
â”‚
â”œâ”€ Socket.IO emite evento a Frontend
â”‚
â”œâ”€ WhatsAppService.js escucha 'message_sent'
â”‚
â””â”€ FIN: Actualiza UI, muestra confirmaciÃ³n
```

## Flujo de RecepciÃ³n de Mensaje

```
â”Œâ”€ INICIO: Whapi recibe mensaje en WhatsApp
â”‚
â”œâ”€ Whapi envÃ­a POST a: /api/comunicacion/webhook
â”‚  Body: { messages: [{ id, from, body, timestamp }] }
â”‚
â”œâ”€ Route Handler: POST /api/comunicacion/webhook
â”‚
â”œâ”€ Para cada mensaje:
â”‚  â”‚
â”‚  â”œâ”€ Valida contenido
â”‚  â”‚
â”‚  â”œâ”€ Extrae telÃ©fono de 'from'
â”‚  â”‚
â”‚  â”œâ”€ Obtiene: req.app.locals.whatsappIntegration
â”‚  â”‚
â”‚  â”œâ”€ Ejecuta: procesarMensajeRecibido(message)
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ Busca cliente en BD por telÃ©fono
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ Â¿Cliente existe?
â”‚  â”‚  â”‚  â”œâ”€ NO â†’ Retorna null, continÃºa con siguiente
â”‚  â”‚  â”‚  â””â”€ SÃ â†’ ContinÃºa
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ Verifica duplicados en BD
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ INSERT INTO comunicacion_mensajes
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ io.emit('new_message_received', {
â”‚  â”‚     clienteId, clienteNombre, mensaje, telefono, timestamp
â”‚  â”‚  })
â”‚  â”‚
â”‚  â””â”€
â”‚
â”œâ”€ Socket.IO emite evento a todos los clientes conectados
â”‚
â”œâ”€ Frontend (WhatsAppService.js) escucha 'new_message_received'
â”‚
â”œâ”€ Actualiza lista de mensajes
â”‚
â”œâ”€ Notifica al usuario
â”‚
â””â”€ FIN: Mensaje visible en la conversaciÃ³n
```

## Estructura de Datos

### Tabla: comunicacion_mensajes
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id (PK)                    | INTEGER              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cliente_id (FK)            | INTEGER              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ mensaje                    | TEXT                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ remitente                  | VARCHAR(100)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tipo                       | ENUM(enviado, rec..) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ estado                     | VARCHAR(50)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ whapi_message_id           | VARCHAR(100)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ creado_en                  | TIMESTAMP            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Componentes e Interfaces

### WhatsAppIntegration (Servicio Central)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     WhatsAppIntegration               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Propiedades:                         â”‚
â”‚  - io: Socket.IO instance            â”‚
â”‚  - isConnected: boolean              â”‚
â”‚  - messageQueue: array               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MÃ©todos PÃºblicos:                   â”‚
â”‚  + initialize()                      â”‚
â”‚  + verifyWhapiConnection()           â”‚
â”‚  + enviarMensaje(...)                â”‚
â”‚  + procesarMensajeRecibido(...)      â”‚
â”‚  + obtenerHistorial(...)             â”‚
â”‚  + enviarMensajeMasivo(...)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MÃ©todos Privados:                   â”‚
â”‚  - enviarPorWhapi(...)               â”‚
â”‚  - simularEnvio(...)                 â”‚
â”‚  - guardarMensajeEnBD(...)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Tipos de Eventos Socket.IO

### Servidor â†’ Cliente
```
message_sent
â”œâ”€ messageId: string
â”œâ”€ telefono: string
â”œâ”€ mensaje: string
â”œâ”€ clienteId: number
â”œâ”€ timestamp: ISO8601
â””â”€ provider: 'whapi' | 'simulated'

new_message_received
â”œâ”€ clienteId: number
â”œâ”€ clienteNombre: string
â”œâ”€ mensaje: string
â”œâ”€ telefono: string
â”œâ”€ messageId: string
â””â”€ timestamp: ISO8601

bulk_message_start
â”œâ”€ total: number
â””â”€ timestamp: ISO8601

bulk_message_progress
â”œâ”€ current: number
â”œâ”€ total: number
â”œâ”€ exitosos: number
â”œâ”€ errores: number
â””â”€ porcentaje: number (0-100)

bulk_message_complete
â”œâ”€ exitosos: number
â”œâ”€ errores: number
â”œâ”€ total: number
â””â”€ timestamp: ISO8601

whatsapp_status
â”œâ”€ connected: boolean
â”œâ”€ provider: string
â””â”€ timestamp: ISO8601
```

### Cliente â†’ Servidor
```
send_message
â”œâ”€ to: string (nÃºmero de telÃ©fono)
â””â”€ message: string

send_to_active
â””â”€ message: string

send_bulk
â”œâ”€ numbers: array
â””â”€ message: string

select_chat
â””â”€ chatJid: string
```

## ConfiguraciÃ³n y Variables de Entorno

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           VARIABLES DE ENTORNO                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ # WHAPI                                          â”‚
â”‚ WHAPI_TOKEN=xxx...                              â”‚
â”‚ WHAPI_API_URL=https://api.whapi.cloud            â”‚
â”‚                                                  â”‚
â”‚ # BASE DE DATOS                                  â”‚
â”‚ DB_HOST=localhost                                â”‚
â”‚ DB_PORT=5432                                     â”‚
â”‚ DB_USER=usuario                                  â”‚
â”‚ DB_PASSWORD=contraseÃ±a                          â”‚
â”‚ DB_NAME=crm_whatsapp                            â”‚
â”‚                                                  â”‚
â”‚ # SERVIDOR                                       â”‚
â”‚ PORT=5000                                        â”‚
â”‚ NODE_ENV=development                            â”‚
â”‚                                                  â”‚
â”‚ # JWT (Futuro)                                   â”‚
â”‚ JWT_SECRET=xxx...                                â”‚
â”‚ JWT_EXPIRY=24h                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Puntos de IntegraciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        PUNTOS DONDE SE ACCEDE AL SERVICIO          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  1. req.app.locals.whatsappIntegration              â”‚
â”‚     â””â”€ En cualquier route handler                  â”‚
â”‚                                                     â”‚
â”‚  2. req.app.locals.io                              â”‚
â”‚     â””â”€ Para emitir eventos Socket.IO               â”‚
â”‚                                                     â”‚
â”‚  3. Frontend: socket.on('event', ...)              â”‚
â”‚     â””â”€ En componentes React                        â”‚
â”‚                                                     â”‚
â”‚  4. Frontend: socket.emit('event', data)           â”‚
â”‚     â””â”€ Para enviar eventos al servidor             â”‚
â”‚                                                     â”‚
â”‚  5. Base de datos: INSERT/SELECT                   â”‚
â”‚     â””â”€ Persistencia de mensajes                    â”‚
â”‚                                                     â”‚
â”‚  6. Whapi API: POST/GET                            â”‚
â”‚     â””â”€ IntegraciÃ³n con WhatsApp real               â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Estados y Transiciones

```
ConexiÃ³n WhatsApp:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Inicial â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Conectando  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
       â”‚                              â”‚
       â–¼                              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  QR Code     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Esperando   â”‚
  â”‚  Escanear    â”‚              â”‚  Escaneo     â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Conectado   â”‚ â—„â”€â”
  â”‚  (Activo)    â”‚   â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
       â”‚              â”‚ (Auto-reconexiÃ³n)
       â–¼              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  Desconectadoâ”‚ â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Ãšltima actualizaciÃ³n:** 4 de diciembre de 2025
**VersiÃ³n:** 1.0.0
